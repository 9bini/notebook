input {
  beats {
    port => 5044
    host => "0.0.0.0"
  }
  
  # UDP 로그 수신 (syslog 등)
  udp {
    port => 5000
    codec => "json"
  }
  
  # Redis에서 로그 수신 (버퍼링용)
  redis {
    host => "redis"
    port => 6379
    data_type => "list"
    key => "logstash"
  }
}

filter {
  # 기본 필드 추가
  mutate {
    add_field => { "[@metadata][index_prefix]" => "logs" }
    add_field => { "processed_at" => "%{@timestamp}" }
  }
  
  # JSON 로그 파싱
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
      target => "json_data"
    }
    
    if "_jsonparsefailure" not in [tags] {
      mutate {
        replace => { "message" => "%{[json_data][message]}" }
        add_field => { "log_level" => "%{[json_data][level]}" }
        add_field => { "service_name" => "%{[json_data][service]}" }
      }
    }
  }
  
  # 로그 타입별 처리
  if [logtype] == "application" {
    # 애플리케이션 로그 처리
    mutate {
      add_tag => [ "application" ]
    }
    
    # 에러 로그 식별
    if [log_level] in ["ERROR", "FATAL", "error", "fatal"] {
      mutate {
        add_tag => [ "error" ]
        add_field => { "alert_required" => "true" }
      }
    }
    
    # 성능 로그 식별
    if [message] =~ /response_time|duration|latency/ {
      grok {
        match => { "message" => "response_time=%{NUMBER:response_time:float}" }
      }
      
      if [response_time] {
        if [response_time] > 1000 {
          mutate {
            add_tag => [ "slow_response" ]
          }
        }
      }
    }
  }
  
  if [logtype] == "access" {
    # 액세스 로그 처리 (nginx/apache)
    grok {
      match => { 
        "message" => '%{COMBINEDAPACHELOG}' 
      }
    }
    
    mutate {
      add_tag => [ "access" ]
      convert => { "response" => "integer" }
      convert => { "bytes" => "integer" }
    }
    
    # HTTP 상태 코드별 태그
    if [response] >= 400 {
      mutate {
        add_tag => [ "http_error" ]
      }
    }
    
    if [response] >= 500 {
      mutate {
        add_tag => [ "server_error" ]
        add_field => { "alert_required" => "true" }
      }
    }
  }
  
  if [logtype] == "system" {
    # 시스템 로그 처리
    mutate {
      add_tag => [ "system" ]
    }
    
    # 인증 실패 감지
    if [message] =~ /authentication failure|failed login|invalid user/ {
      mutate {
        add_tag => [ "auth_failure" ]
        add_field => { "alert_required" => "true" }
      }
    }
  }
  
  # Docker 컨테이너 로그 처리
  if [container] {
    mutate {
      add_tag => [ "docker" ]
      add_field => { "container_name" => "%{[container][name]}" }
      add_field => { "container_image" => "%{[container][image]}" }
    }
  }
  
  # 날짜 파싱
  if [timestamp] {
    date {
      match => [ "timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss", "yyyy-MM-dd'T'HH:mm:ss.SSSSSS'Z'" ]
      target => "@timestamp"
    }
  }
  
  # IP 정보 추가 (GeoIP)
  if [clientip] {
    geoip {
      source => "clientip"
      target => "geoip"
    }
  }
  
  # 환경별 인덱스 설정
  if [environment] {
    mutate {
      replace => { "[@metadata][index_prefix]" => "logs-%{environment}" }
    }
  } else {
    mutate {
      add_field => { "environment" => "unknown" }
      replace => { "[@metadata][index_prefix]" => "logs-unknown" }
    }
  }
  
  # 불필요한 필드 제거
  mutate {
    remove_field => [ "agent", "ecs", "input", "log", "host.architecture", "host.os" ]
  }
  
  # 민감 정보 마스킹
  mutate {
    gsub => [
      "message", "password=\w+", "password=***",
      "message", "token=[\w\-\.]+", "token=***",
      "message", "\b\d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?\d{4}\b", "****-****-****-****"
    ]
  }
}

output {
  # Elasticsearch 출력
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "%{[@metadata][index_prefix]}-%{+YYYY.MM.dd}"
    
    # 인덱스 템플릿 설정
    template_name => "logs-template"
    template_pattern => "logs-*"
    template => {
      "index_patterns" => ["logs-*"],
      "settings" => {
        "number_of_shards" => 1,
        "number_of_replicas" => 0,
        "index.refresh_interval" => "5s",
        "index.codec" => "best_compression"
      },
      "mappings" => {
        "properties" => {
          "@timestamp" => {
            "type" => "date"
          },
          "log_level" => {
            "type" => "keyword"
          },
          "service_name" => {
            "type" => "keyword"
          },
          "environment" => {
            "type" => "keyword"
          },
          "message" => {
            "type" => "text",
            "analyzer" => "standard"
          },
          "response_time" => {
            "type" => "float"
          }
        }
      }
    }
  }
  
  # 에러 로그는 별도 알림 시스템으로 전송
  if "error" in [tags] or "server_error" in [tags] or "auth_failure" in [tags] {
    # Redis에 알림용 큐 저장
    redis {
      host => "redis"
      port => 6379
      data_type => "list"
      key => "alerts"
    }
    
    # HTTP 웹훅 알림 (Slack, Teams 등)
    http {
      url => "${WEBHOOK_URL:http://localhost:8080/alerts}"
      http_method => "post"
      format => "json"
      mapping => {
        "level" => "%{log_level}"
        "service" => "%{service_name}"
        "message" => "%{message}"
        "timestamp" => "%{@timestamp}"
        "environment" => "%{environment}"
      }
    }
  }
  
  # 개발 환경에서 디버깅용 출력
  if [environment] == "development" {
    stdout {
      codec => rubydebug {
        metadata => true
      }
    }
  }
  
  # 메트릭 수집을 위한 통계 정보
  statsd {
    host => "localhost"
    port => 8125
    namespace => "logstash"
    sender => "logstash"
    gauge => {
      "logs.processed" => 1
      "logs.%{logtype}" => 1
      "logs.%{environment}" => 1
    }
  }
}