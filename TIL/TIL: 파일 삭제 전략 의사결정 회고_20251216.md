# 파일 삭제 전략 의사결정 회고

## 배경

도메인 엔티티가 파일을 참조(fileId)하는 구조에서, 엔티티 삭제 시 S3를 어떻게 안정적으로 수행할지 전략을 논의했다. 핵심 쟁점은 “누락 리스크 vs 운영 비용/복잡도” 였다.

### 옵션 A: 이벤트 기반 상태 변경(내 의견)

- 개요
  - 엔티티가 삭제되거나 fileId가 수정될 때, 파일 모듈의 파일 상태 변경 인터페이스를 호출하여 파일을 삭제 대상 상태로 전환한다.

- 장점
  - 파일 테이블만 보고 삭제 대상을 파악 가능 → 삭제 배치/정리 작업이 단순해진다.
  - 삭제 후보가 “명시적으로” 기록되므로 관측성과 추적이 좋다(누가/언제/왜 상태를 바꿨는지).

- 단점/리스크
  - 엔티티 삭제/수정 로직마다 호출이 필요 → 누락 가능성(휴먼 에러, 신규 엔티티 추가 시 반영 누락).
  - 파일 업로드를 사용하는 모든 곳에 호출 규칙이 퍼짐 → 도메인 코드가 파일 라이프사이클을 계속 의식해야 함.
  - 운영 관점에서 “호출 누락”은 데이터/스토리지 누수로 연결되며, 발견이 늦어질 수 있다.

⸻

### 옵션 B: 정기 스캔 기반 정리(다른 사람 의견, 채택)

- 개요
  - 사용자 사용량이 낮은 시간대에 fileId를 가진 모든 엔티티를 스캔하여,
  - 참조되지 않는 파일(또는 삭제 정책 대상)을 찾아 삭제한다.

- 장점
  - 엔티티에서 별도 호출이 필요 없음 → 호출 누락 리스크 제거(가장 큰 의사결정 포인트).
  - 도메인 로직이 파일 라이프사이클을 신경 쓰지 않아도 됨 → 출시 초기 생산성/개발 편의성이 높다.

- 단점/리스크
  - 모든 엔티티 스캔 비용 증가: 데이터가 커질수록 시간/메모리/DB 부하가 선형 혹은 그 이상으로 증가 가능.
  - 엔티티가 추가될 때마다 스캔 대상 확장 작업 필요 → 파일 모듈이 “어떤 엔티티들이 fileId를 가지는지” 알아야 함.
  - 파일을 즉시 삭제하지 못해 S3 최소 보관 기간(예: 1일) 이 생기면 비용이 발생할 수 있다.
  - 의존성 관점에서 파일 모듈이 엔티티를 “조회/인지”해야 하므로 구조적으로 역방향 의존이 생기는 느낌이 있다.

### 최종 결론 및 채택 사유

- 표결: 2 : 1로 옵션 B(정기 스캔) 채택
- 결정의 핵심 근거:
  - “파일 상태 변경 호출 누락”이 발생하면 누수/정합성 문제로 이어지고, 출시 초기에는 특히 발견/제어가 어렵다.
  - 도메인 로직에서 파일 관련 분기/규칙을 최소화해 출시 생산성을 높이고 싶었다.
  - 아직 출시 전 단계라 운영 최적화보다 “안정적으로 돌아가는 기본 메커니즘”을 우선했다.

### 회고 (개인)

- 내가 제안한 방식이라 무의식적으로 편향이 들어갔던 것 같다(구현 편의/내가 잘 아는 형태에 끌림).
- 설득을 말로만 진행했다.
- 다음에는 자료 혹은 화이트 보드 역햘을 할 수 있는 것을 준비할 예정입니다.
