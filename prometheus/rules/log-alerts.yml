groups:
- name: log_alerts
  interval: 30s
  rules:
  
  # 에러 로그 증가 알림
  - alert: HighErrorLogRate
    expr: |
      (
        increase(elasticsearch_indices_search_query_total{index=~"logs-.*"}[5m]) > 0
        and
        increase(logstash_events{pipeline="main"}[5m]) > 100
      )
    for: 1m
    labels:
      severity: warning
      service: logging
      type: error_rate
    annotations:
      summary: "높은 에러 로그 발생률 감지"
      description: "지난 5분간 에러 로그가 {{ $value }}건 발생했습니다."
      runbook_url: "https://wiki.company.com/runbooks/high-error-rate"

  # 심각한 에러 로그 알림
  - alert: CriticalErrorDetected
    expr: |
      increase(logstash_events{pipeline="main",tags=~".*error.*"}[1m]) > 10
    for: 0m
    labels:
      severity: critical
      service: logging
      type: critical_error
    annotations:
      summary: "심각한 에러 다발 발생"
      description: "지난 1분간 {{ $value }}건의 심각한 에러가 발생했습니다."
      runbook_url: "https://wiki.company.com/runbooks/critical-errors"

  # 응답 시간 지연 알림
  - alert: HighResponseTime
    expr: |
      avg_over_time(logstash_events{tags=~".*slow_response.*"}[5m]) > 5
    for: 2m
    labels:
      severity: warning
      service: performance
      type: latency
    annotations:
      summary: "높은 응답 시간 감지"
      description: "평균 응답 시간이 임계값을 초과했습니다."
      threshold: "1000ms"
      runbook_url: "https://wiki.company.com/runbooks/high-latency"

  # 인증 실패 알림
  - alert: AuthenticationFailures
    expr: |
      increase(logstash_events{tags=~".*auth_failure.*"}[5m]) > 20
    for: 1m
    labels:
      severity: warning
      service: security
      type: auth_failure
    annotations:
      summary: "다중 인증 실패 감지"
      description: "지난 5분간 {{ $value }}건의 인증 실패가 발생했습니다."
      runbook_url: "https://wiki.company.com/runbooks/auth-failures"

  # 시스템 리소스 알림
  - alert: LogProcessingLag
    expr: |
      (
        rate(filebeat_events_total[5m]) - 
        rate(logstash_events{pipeline="main"}[5m])
      ) > 1000
    for: 3m
    labels:
      severity: warning
      service: logging
      type: processing_lag
    annotations:
      summary: "로그 처리 지연 발생"
      description: "로그 수집과 처리 사이에 지연이 발생하고 있습니다."
      runbook_url: "https://wiki.company.com/runbooks/processing-lag"

- name: infrastructure_alerts
  interval: 60s
  rules:
  
  # Elasticsearch 클러스터 상태
  - alert: ElasticsearchClusterDown
    expr: elasticsearch_cluster_health_status != 0
    for: 1m
    labels:
      severity: critical
      service: elasticsearch
      type: cluster_health
    annotations:
      summary: "Elasticsearch 클러스터 이상"
      description: "Elasticsearch 클러스터 상태가 비정상입니다."

  # Logstash 파이프라인 상태
  - alert: LogstashPipelineDown
    expr: logstash_pipeline_up != 1
    for: 2m
    labels:
      severity: critical
      service: logstash
      type: pipeline_down
    annotations:
      summary: "Logstash 파이프라인 중단"
      description: "Logstash 파이프라인이 중단되었습니다."

  # 디스크 사용량 알림
  - alert: HighDiskUsage
    expr: |
      (
        (node_filesystem_size_bytes - node_filesystem_avail_bytes) / 
        node_filesystem_size_bytes
      ) * 100 > 85
    for: 5m
    labels:
      severity: warning
      service: system
      type: disk_usage
    annotations:
      summary: "디스크 사용량 높음"
      description: "디스크 사용량이 {{ $value }}%에 달했습니다."

  # 메모리 사용량 알림
  - alert: HighMemoryUsage
    expr: |
      (
        (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / 
        node_memory_MemTotal_bytes
      ) * 100 > 90
    for: 3m
    labels:
      severity: warning
      service: system
      type: memory_usage
    annotations:
      summary: "메모리 사용량 높음"
      description: "메모리 사용량이 {{ $value }}%에 달했습니다."

- name: business_logic_alerts
  interval: 30s
  rules:
  
  # 비즈니스 로직 에러 패턴
  - alert: PaymentFailureSpike
    expr: |
      increase(
        logstash_events{
          service_name="payment-service",
          tags=~".*error.*"
        }[5m]
      ) > 50
    for: 1m
    labels:
      severity: critical
      service: payment
      type: business_error
    annotations:
      summary: "결제 실패 급증"
      description: "지난 5분간 결제 실패가 {{ $value }}건 발생했습니다."

  # 사용자 경험 관련 알림
  - alert: UserSessionErrors
    expr: |
      increase(
        logstash_events{
          service_name="session-service",
          log_level="ERROR"
        }[10m]
      ) > 100
    for: 2m
    labels:
      severity: warning
      service: user_experience
      type: session_error
    annotations:
      summary: "사용자 세션 에러 증가"
      description: "사용자 세션 관련 에러가 증가하고 있습니다."